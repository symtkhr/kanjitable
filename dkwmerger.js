var cjkcompat = require("./cjkcompat.js");

const prv_list = {
"01480":["𠔜_xx"],"07515":["𡭼_xx"],"07547":["𡯈_xx"],"10343":["𢗂_xx"],"11398d":["𢤚_xx"],
"13219":["㪎_xx"],"14404":["𣎟_xx"],"14891":["𣒈_xx"],"16017":["欥_xx"],"18014":["㴳_xx"],
"18543":["濳_xx"],"21362":["𤫝_xx"],"24791":["𥛅_xx"],"24908":["禾_xx"],"27700":["緻_xx"],
"28889":["𦓚_xx"],"32491":["𧃒_xx"],"40324":["銏_xx"],"41407":["閷_xx"],"41806":["随_xx"],
"43471":["𩒢_xx"],"45740":["𩱪_xx"],"49078":["𢌃_xx"],"49201":["𣬎_xx"],"49238":["㶖_xx",true],
"49465":["糱_xx"],"49587":["𦱏_xx"],"49799":["𧰌_xx"],"49802":["𢨒_xx"],"h0115":["𡚓_xx"],
"h0135":["𡪗_xx"],"h0225":["𢾿_xx"],"h0230":["𣅀_xx"],"h0439":["𥥜_xx"],"h0458":["𥮟_xx"],
"h0505":["𦙜_xx"],"h0660":["𨭻_xx"],"h0689":["𨿊_xx"],"14342":["肭_xx",true],"14344":["䏙_xx",true],
"14379":["䐋_xx",true],"14387":["朡_xx",true],"14394":["𣎓_xx",true],"14403":["𣎜_xx",true],
"06038":["𡚨",true],"49065":["𡿫_00"],"49470":["絛"],"00054":["並_00"],"00094":["丸_00"],
"00104":["丽_01"],"00109":["乁_00"],"00263":["𠄢_00"],"00471":["你_00"],"00509":["体_00"],
"00629d":["侮_00"],"00630":["侮_01"],"00967":["備_00"],"01084":["像_00"],"01117":["僧_01"],
"01345":["充_00"],"01368d":["兔_01"],"01473":["具_00"],"01504":["㒹_01"],"01620":["况_00"],
"01727":["𩇟_00"],"01850":["刃_00"],"01858":["切_00"],"02112d":["割_01"],"02360d":["勇_00"],
"02362":["勉_00"],"02384d":["勉_01"],"02415d":["勤_00"],"02424":["勤_01"],"02495":["勺_01"],
"02506d":["包_00"],"02574":["北_00"],"02706":["卉_00"],"02738":["卑_00"],"02761d":["博_00"],
"02855":["即_00"],"02872":["卽_00"],"02880":["卿_02"],"03067":["𠘯_00"],"03081":["𡿮_00"],
"03118d":["及_00"],"03248":["叱_00",true],"03283":["吆_00"],"03372d":["吸_00"],"03385":["咞_01"],
"03401":["呈_00"],"03441d":["周_01"],"03672":["哶_00"],"03709d":["唐_00"],"03904":["善_00"],
"03951":["喙_00"],"03960":["喝_01"],"03987d":["喫_00"],"04022":["喳_00"],"04037":["嗂_00"],
"04138d":["嘆_01"],"04171":["嘆_00"],"04349d":["器_00"],"04376":["器_01"],"04832":["圖_00"],
"04841d":["圗_01"],"05030":["型_00"],"05086d":["城_01"],"05188":["埴_00"],"05275":["報_00"],
"05276":["堲_00"],"05345":["塚_01"],"05469":["墨_00"],"05585":["𡓤_00"],"05642":["壮_00"],
"05801d":["夢_00"],"05964":["奢_00"],"06199":["姘_00"],"06230":["姬_01"],"06432d":["婦_00"],
"06531":["㛼_00"],"06872":["嬾_00",true],"07068":["𡧈_00"],"07089":["宐_00"],"07257":["寘_00"],
"07296d":["寧_01"],"07419d":["寿_00"],"07437d":["将_01"],"07463d":["導_00"],"07583":["𡯭_00"],
"07798":["層_01"],"07825":["屮_00"],"07826":["屮_01"],"08052":["岍_01"],"08066":["𡷤_00"],
"08119":["𡷦_00"],"08212d":["崩_00"],"08354":["嵫_00"],"08360":["嵮_01"],"08532":["嶲_01"],
"08680d":["巡_00"],"08696":["巢_00"],"08972":["帽_00"],"09107":["㡢_00"],"09109":["幩_01"],
"09159":["𢆃_00"],"09185":["𢆟_00"],"09299":["㡼_00"],"09349":["庰_00"],"09437":["廊_01"],
"09472":["𪎒_00"],"09538":["𢋱_00"],"09583":["廾_00"],"09593":["𢌱_00"],"09791d":["弱_00"],
"09915":["㣇_00"],"09958":["𦇚_00"],"09969":["形_00"],"09995d":["彫_00"],"10116":["㣣_00"],
"10312d":["忍_00"],"10617d":["悔_01"],"10623":["悁_00"],"10659":["悔_00"],"10687":["㤺_00"],
"10756d":["情_00"],"10759":["惇_00"],"10787":["𢛔_00"],"10905d":["愉_00"],"10980d":["慈_00"],
"11024d":["慎_00"],"11154":["慺_00"],"11188d":["憎_01"],"11202":["憎_00"],"11261":["憯_00"],
"11262":["𢡄_00"],"11269d":["憲_00"],"11399d":["懲_00"],"11455":["懶_00"],"11542d":["成_00"],
"11598":["戛_00"],"11743d":["扇_00"],"11800":["扝_00"],"11917d":["抱_00"],"12012":["拼_00"],
"12150":["捐_00"],"12191d":["捨_00"],"12237d":["掃_00"],"12285":["掩_00"],"12324":["揅_00"],
"12373":["揤_00"],"12459":["損_00"],"12613d":["摩_00"],"12643":["摷_00"],"12716":["撝_00"],
"13202d":["敏_01"],"13217":["敏_00"],"13285d":["敬_00"],"13359d":["敷_00"],"13721":["既_01"],
"13994":["晴_00"],"13994d":["晴_01"],"14031d":["暑_00"],"14051":["暑_01"],"14061":["㬈_00"],
"14082":["暜_00"],"14227d":["曜_00"],"14294":["書_01"],"14301":["最_00"],"14334":["𣍟_00"],
"14340d":["朋_00"],"14345d":["服_00"],"14362d":["朗_01"],"14364":["朗_03"],"14368d":["望_00"],
"14374d":["朝_00"],"14525":["枅_00"],"14584":["柺_02"],"14685":["桒_01"],"14710":["栟_00"],
"14795d":["梅_01"],"14830":["梅_00"],"14840":["梎_00"],"15033":["椔_00"],"15094":["楂_00"],
"15251":["榣_00"],"15880d":["欄_01"],"15904":["欄_00"],"15992d":["次_00"],"16049":["𣢧_00"],
"16248":["㱎_01"],"16629":["殺_01"],"16635":["𣪍_00"],"16638":["殺_00"],"16728":["𡴋_00"],
"17120":["汎_00"],"17210":["沗_00"],"17400":["汧_00"],"17428":["派_00",true],"17450":["海_01"],
"17459":["𣴞_00"],"17479d":["浩_00"],"17503":["海_00"],"17505d":["浸_00"],"17521":["涅_00"],
"17529d":["消_00"],"17572d":["流_00"],"17574":["𣵀_00"],"17621":["洴_00"],"17758":["渚_00"],
"17783d":["港_00"],"17914":["湮_00"],"17915":["滛_03"],"17919d":["滋_00"],"18010":["滇_00"],
"18068d":["漢_00"],"18101":["漁_00"],"18153":["漢_01"],"18277d":["潮_01"],"18371":["濆_00"],
"18656":["瀛_01"],"18750":["灊_00"],"18773":["㶖_00"],"18859":["灰_00"],"18871":["灷_00"],
"18879":["災_00"],"18953":["炭_00"],"19121":["𤉣_00"],"19165d":["煮_00"],"19188":["煮_01"],
"19326":["熜_00"],"19428":["𤎫_00"],"19648":["爨_01"],"19710d":["爵_01"],"19869":["牐_00"],
"20045":["犀_00"],"20122":["犕_00"],"20236":["犮_00"],"20267":["𤜵_00"],"20511d":["猪_01"],
"20534":["猪_00"],"20714d":["獣_00"],"20775":["獸_00"],"20817d":["率_00"],"20821":["玉_00"],
"21058":["琢_00"],"21102":["瑇_00"],"21129":["瑜_00"],"21160":["瑬_00"],"21167":["瑱_00"],
"21201":["璅_00"],"21459":["㼛_00"],"21739d":["画_00"],"21742":["甾_00"],"21752":["𢍁_00"],
"21788":["𤰶_00"],"21854":["異_00"],"22809":["𤾸_00"],"22950":["𥁄_00"],"22954":["㿼_00"],
"22972":["益_01"],"22972d":["益_00"],"23001d":["盛_00"],"23122":["𥃲_00"],"23125":["𥃳_00"],
"23136":["直_00"],"23162":["䀘_00"],"23199":["𥄙_00"],"23200":["𥄚_00"],"23236":["真_00"],
"23376":["睊_00"],"23436":["䁆_00"],"23568":["瞋_00"],"23657":["𥉉_00"],"24037":["𥐝_00"],
"24120d":["砲_00"],"24175":["硎_00"],"24201d":["硝_00"],"24289":["碑_00"],"24364d":["碑_01"],
"24396":["磌_00"],"24449d":["磨_00"],"24475":["䃣_00"],"24626":["礼_01"],"24626d":["礼_00"],
"24631":["社_01"],"24631d":["社_00"],"24640":["祈_00"],"24640d":["祈_01"],"24641":["祉_01"],
"24641d":["祉_00"],"24652":["祐_00"],"24652d":["祐_01"],"24664":["祖_01"],"24664d":["祖_00"],
"24672":["祝_00"],"24672d":["祝_01"],"24673":["神_00"],"24673d":["神_01"],"24689":["祥_00"],
"24689d":["祥_01"],"24741d":["禄_00"],"24766":["禍_00"],"24766d":["禍_01"],"24767":["禎_01"],
"24767d":["禎_00"],"24768":["福_01"],"24768d":["福_00"],"24787d":["禅_00"],"24944":["䄯_00"],
"25016d":["称_00"],"25081d":["程_00"],"25188d":["穀_01"],"25221":["穀_00"],"25280d":["穏_00"],
"25334d":["穫_00"],"25424":["突_00"],"25439":["突_01"],"25804":["竮_00"],"25811":["𥪧_00"],
"26069":["筭_00"],"26102":["節_00"],"26182":["𥮫_00"],"26295":["䈧_00"],"26429":["𥲀_00"],
"26623d":["簿_00"],"26813":["籯_00"],"26848":["类_01"],"26857":["籾_01"],"26997":["精_00"],
"26997d":["精_01"],"27065":["糒_00"],"27119":["糣_00"],"27230":["𥾆_00"],"27258d":["級_00"],
"27429":["絣_00"],"27600":["緇_00"],"27631d":["練_01"],"27689":["練_00"],"27803d":["繁_00"],
"27805d":["縫_00"],"27849":["繁_01"],"27854":["繅_00"],"28096":["䌴_00"],"28119":["𦈨_00"],
"28143":["缾_00"],"28161":["𦉇_00"],"28274":["䍙_00"],"28309":["𦋙_00"],"28311d":["署_01",true],
"28319":["署_00"],"28350":["罺_00"],"28414":["𦌾_00"],"28614":["羽_00"],"28614d":["羽_01"],
"28657d":["翌_00"],"28672d":["習_00"],"28852":["者_00"],"28853":["者_01"],"28892":["𦓚_00"],
"28907d":["耕_00"],"28909d":["耗_00"],"28973":["𦔘_00"],"29066":["聠_00"],"29074d":["聖_00"],
"29111":["𦖝_00"],"29125":["𦖨_00"],"29154":["聰_00"],"29237":["月_00"],"29263d":["肖_00"],
"29318":["育_00"],"29396d":["胞_00"],"29422d":["肺_00"],"29808d":["膜_00"],"30103d":["臭_00"],
"30108":["臭_01"],"30149":["致_00",true],"30342d":["舞_00"],"30420":["䑫_00"],"30670d":["芋_00"],
"30699d":["芝_00"],"30734d":["花_00"],"30736d":["芳_00"],"30741d":["芸_00"],"30781d":["苗_00"],
"30796d":["若_00"],"30797d":["苦_00"],"30808d":["英_00"],"30833d":["茂_00"],"30915d":["茶_00"],
"30945d":["草_00"],"30953d":["荒_00"],"31000d":["荷_00"],"31119":["華_00",true],"31153d":["菊_00"],
"31156d":["菌_00"],"31163":["𦰶_00"],"31168d":["菓_00"],"31184d":["菜_00"],"31302":["著_00"],
"31362d":["落_00"],"31387d":["葉_00"],"31392":["𦳕_00"],"31448d":["葬_00"],"31618d":["蒸_00"],
"31642d":["蓄_00"],"31828d":["蔦_00"],"31926":["𧏊_00"],"32056":["𦼬_00"],"32083d":["薄_00"],
"32143d":["薦_00"],"32149d":["薪_00"],"32211":["𦾱_00"],"32276":["𦿔_00"],"32340d":["藤_00"],
"32346d":["藩_00"],"32470":["䕲_00"],"32477.2":["蘭_00"],"32678d":["虐_00"],"32710":["虜_03"],
"32720d":["虜_01"],"32723d":["虞_00"],"32770":["虧_00"],"32902":["蚩_00"],"32984":["蚫_00"],
"33019":["蛢_00"],"33049":["蚈_00"],"33306":["蝫_00"],"33376":["䗗_00"],"33396":["蝹_00"],
"33594":["蟡_00"],"33682":["蠁_00"],"33981":["衆_00"],"34046d":["術_00"],"34076":["衠_00"],
"34113":["𧘙_00"],"34163":["𧙧_00"],"34265":["裗_01"],"34373":["裺_00"],"34493":["𧜁_00"],
"34545":["襁_00"],"34768d":["要_00"],"34789d":["覆_00"],"34827d":["視_00"],"34836":["視_01"],
"35218":["䚰_00"],"35232":["𧥦_00"],"35497d":["誠_00"],"35502d":["認_00"],"35546d":["誤_00"],
"35556":["說_00"],"35609d":["調_00"],"35640d":["請_00"],"35687":["諾_00"],"35690d":["謁_01"],
"35691d":["諸_01"],"35727d":["諭_01",true],"35743":["諸_00"],"35757":["謁_00"],"35780d":["謄_00"],
"35821d":["謙_00"],"35850d":["謹_01"],"35900":["謹_00"],"35989":["警_00"],"36038d":["護_00"],
"36117":["變_00"],"36334":["豕_00"],"36510":["𧲨_00"],"36727":["賁_00"],"36788":["賓_00"],
"36920d":["贈_00"],"36929":["贈_01"],"37048":["起_00"],"37230":["𧼯_00"],"37526":["跰_00"],
"37527":["趼_00"],"37955d":["躍_00"],"38180":["𠣞_00"],"38438d":["輸_00"],"38482d":["轄_00"],
"38710d":["辺_00"],"38712d":["込_00"],"38727d":["迅_00"],"38748d":["迎_00"],"38752d":["近_00"],
"38758d":["返_00"],"38797d":["迫_00"],"38800d":["迭_00"],"38803d":["述_00"],"38825d":["迷_00"],
"38836d":["追_00"],"38839d":["退_00"],"38842d":["送_00"],"38845d":["逃_00"],"38849d":["逆_00"],
"38876d":["透_00"],"38877d":["逐_00"],"38881d":["逓_00"],"38882d":["途_00"],"38892d":["通_00"],
"38897d":["速_00"],"38898d":["造_00"],"38902d":["連_01"],"38931d":["逮_00"],"38937d":["週_00"],
"38943d":["進_00"],"38989d":["遅_00"],"38991d":["遇_00"],"38994d":["遊_00"],"38998d":["運_00"],
"39001d":["遍_00"],"39002d":["過_00"],"39010d":["道_00"],"39011d":["達_00"],"39012":["𨔬_00"],
"39047d":["遠_00"],"39052d":["遣_00"],"39076d":["適_00"],"39082d":["遭_00"],"39118d":["遵_00"],
"39123d":["遷_00"],"39127d":["選_00"],"39132":["𨗭_00"],"39134d":["遺_00"],"39163d":["避_00"],
"39174d":["還_00"],"39214":["邉_0B"],"39497d":["都_01"],"39509":["都_00"],"39602":["鄛_00"],
"39870d":["酷_00"],"40120d":["釈_00"],"40351":["鉼_00"],"40463":["鋗_00"],"40464":["鋘_00"],
"40708d":["鎖_00"],"40896":["鐕_00"],"41233":["開_00"],"41290":["䦕_00"],"41720d":["隆_00"],
"41746":["隆_01"],"41836d":["隠_00"],"41874":["險_00"],"42128d":["難_01"],"42129":["𪍇_00"],
"42145":["難_00"],"42216d":["雪_00"],"42300":["震_00"],"42570":["靖_01"],"42570d":["靖_00"],
"42646":["𩈚_00"],"42941":["䩶_00"],"43318d":["響_00"],"43345":["䪲_00"],"43359":["頋_00"],
"43461":["頩_00"],"43519":["頻_00"],"43608d":["類_01"],"43636":["類_00"],"43689d":["顧_00"],
"43797":["𩖶_00"],"43918":["䬙_00"],"44023d":["飢_00"],"44037":["飦_00"],"44064":["飯_00"],
"44064d":["飯_01"],"44102":["䬳_00"],"44107":["飼_01"],"44107d":["飼_00"],"44109d":["飽_00"],
"44111d":["飾_00"],"44168d":["餓_00"],"44194":["𩜕_00"],"44237":["館_01"],"44237d":["館_00"],
"44239":["餩_01"],"44339":["饂_00"],"44552":["馧_01"],"44623":["駂_00"],"44774":["駾_00"],
"44915d":["騰_00"],"45013d":["驚_00"],"45157":["䯎_00"],"45543":["鬒_00"],"45906d":["魔_00"],
"46226d":["鯛_00"],"46706":["鳽_00"],"46862":["䳎_00"],"47129":["𪃎_00"],"47185":["鶴_01"],
"47622":["𪊑_01"],"47888":["麻_00"],"47909d":["麿_00"],"48286":["鼅_00"],"48317":["鼏_00"],
"48320":["𪔃_00"],"48344":["鼖_00"],"48498d":["鼻_00"],"48656":["𪘀_00"],"48933":["再_01"],
"48957":["𡊏_00"],"48962":["𠭣_00"],"49090":["𣊸_00"],"49163":["𣑭_00"],"49336":["𤲃_01"],
"49373":["𥉱_00"],"49467":["𥾞_01"],"49838":["閷_00"],"49945":["𪊖_00"],"h0037":["冉_00"],
"h0196":["戴_00"],"h0432":["𥡷_01"],"h0460":["節_01"],"h0540":["䖝_00"],"h0550":["衂_00"],
"h0611":["邉_00"],"h0618":["鄕_00"],"h0630":["釼_00"],"h0707":["響_01"],"h0709":["顛_00"],
"h0782":["鶴_00"],"01958":["𠛮_00"],"00004":["𠀀_00"],"05489":["壄_00"],"38630":["辛_01"],
"h0099":["=05474"],
};

const omitlist = {
    kdb: [
        "3","4","8","9","18","68","71","109","115","164","165","172","228","1336","1565","1801","1851","2290","2493","2595",
        "2836","2890","3057","3058","3115","6037","7538","7629","7829","8671","8672","9189","9694","10037",
        "5","981","4576","5483","11627","13197","13203","13457","21488","23095","23096","24372","30149","30986","31689",
        "32165","34559","34683","38996","39494","40373","47258","49408","49502","49590","49870","h156","h526","4462",
    ],
    ipa: [
        "11870","29006","43747","49790","15187","42955","h0619"
    ],
};

const getfile = (fname, cb) => {
    const fs = require('fs');
    const less = fs.readFileSync(fname, 'utf8');
    cb(false,less);
};

String.prototype.toHalf = function() {
    return this.replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
};

// CJK互換を統合漢字に変換する; otherwise false
const is_cjkcompat = (c) => {
    if (c.match(/^[\uF900-\uFAFF]/)) {
        let offset = c.charCodeAt(0) - 0xf900;
        if (offset < 0) return false;
        let uni = cjkcompat[0][offset];
        if (!uni) return false;
        return String.fromCodePoint(uni) || false;
    }
    if (c.match(/^[\uD800-\uDBFF][\uDC00-\uDFFF]/)) {
        c = c.substr(0, 2);
        let code = (c.charCodeAt(0) & 0x3ff) << 10 | (c.charCodeAt(1) & 0x3ff);
        code += 0x10000;
        if (code < 0x2f800 || 0x2fb00 <= code) return false;
        return String.fromCodePoint(cjkcompat[1][code - 0x2f800]);
    }
    return false;
};

const format_dkw = (match, dashlen) => {
    if (!match) return;
    let dkw = parseInt(match[2]);
    dkw = ('00000' + dkw).slice(-5) + "d".repeat(dashlen ? match[3] : match[3].length);
    if (match[1]) dkw = "h" + dkw.slice(1);
    return dkw;
};

Object.keys(omitlist).forEach(key => {
    omitlist[key] = omitlist[key].map(v => format_dkw(v.match(/^(h?)([0-9]+)('*)$/)));
});

const loadfiles = () => {
    let ret = {};

    // JMJ
    getfile("data/mj0502_pickup.txt", (err, txt) => {
        txt.split("\n").forEach((line, i) => {
            if (!line) return;
            let tbl = line.trim().split("\t");
            let dkw = format_dkw(tbl.shift().match(/^(h?)([0-9]+)('*)$/));
            if (!dkw) { console.log(line); return; }

            if (!ret[dkw]) ret[dkw] = {};
	        ret[dkw].jmj = tbl.shift();
	    });
    });

    // KDB
    getfile("data/dkw2ucs.txt", (err, txt) => {
        txt.split("\n").forEach((line, i) => {
            if (!line) return;
            let row = line.trim().split("#");
            if (row[1]) {
                if (row[1].indexOf("missing") != -1) return;
                if (row[1].indexOf("moved") != -1) return;
            }
            let tbl = row.shift().split(" ");
            let dkw = format_dkw(tbl.shift().match(/^D(H?)([0-9]+)\.([0-2])$/), true);
            if (!dkw) { console.log(line); return; }

            tbl.shift();
            tbl.shift();
            tbl.shift();

            if (!ret[dkw]) ret[dkw] = {};
            ret[dkw].kdb = tbl.filter(v => v).map(v => {
                var m = v.match(/^D(H?)([0-9]+)\.([0-2])$/);
                if (!m) return v;
                return "=" + format_dkw(m, true);
            });

	    });
    });

    // IPA moji-lab
    getfile("daikanwa-ucs.txt", (err,txt) => {
	    txt.split("\n").forEach((line, i) => {
		    if (!line) return;
		    if (line[0]=="#") return;
		    let tbl = line.trim().split("\t");
		    let dkw = format_dkw(tbl.shift().match(/^(補?)([0-9]+)('*)$/));
            if (!dkw) { console.log(line); return; }
            
            if (!ret[dkw]) ret[dkw] = {};
            ret[dkw].ipa = tbl.shift().trim().toHalf();
            return;
            if (ret[dkw].ipa.indexOf("CJKF") != 0 && ret[dkw].ipa.indexOf("U+") != 0)
                delete ret[dkw].ipa;
        });
	});

    return ret;
};
const dump_single_diff = () => {

    const ret = loadfiles();

    var kdiff =  Object.keys(ret).map(dkw => {
        var obj = ret[dkw];
        var kdup = obj.kdb.length && (obj.kdb[0].slice(0,1) == "=");

        let ci = (obj.ipa.indexOf("U+") != -1 ? String.fromCodePoint(parseInt(obj.ipa.slice(2), 16)) : (obj.ipa.indexOf("CJKF") != -1 ? "f" : "x"));
        let cj = !obj.jmj ? "x" : String.fromCodePoint(parseInt(obj.jmj, 16));
        let ck = obj.kdb.map(v => String.fromCodePoint(parseInt((kdup ? ret[v.slice(1)].kdb[0] : v).slice(2), 16) || 0x52)).join("");

        if (ci == "f") ci = cj;
        if (ck == "") ck = "x";
        
        if ((ci == ck) && !kdup) return;

        var tret = {dkw:dkw, c:[ci,ck]};
        tret.type = tret.c.map(
            (cs,i) => cs=="x"?"x":
                Array.from(cs).map(c => {
                    if (c == ci) return "A";
                    if (is_cjkcompat(c) == ci) return "a";
                    //if (i==1 && cj == ck) return "B";
                    return "B";
                }).join("")
        );

        //if (jivs) tret.type[1] += "*";
        if (kdup) tret.type[1] += "=";

        tret.type = tret.type.join(":");
        return tret;
    }).filter(v => v)
      .sort((a,b)=>(a.type == b.type ? (a.dkw < b.dkw ? -1 : 1) : (a.type < b.type ? -1 : 1)))
      .forEach(d => {
          var obj = ret[d.dkw];
          var c = d.c;
          if (!obj.jmj) obj.jmj = "-----";
          if (!obj.kdb.length) obj.kdb = ["-"];

          var omit = (omitlist.kdb.indexOf(d.dkw) == -1) ? "" : "#";

          console.log([omit + d.dkw, d.type,
                       obj.kdb.join(";") + "(" + c[1]+")",
                       obj.ipa + "(" + c[0] + ")",
                      ].join("\t"));
      });

    var jmjdiff =  Object.keys(ret).map(dkw => {
        var obj = ret[dkw];
        var jivs = obj.jmj && (obj.jmj.indexOf("_") != -1);
        
        let ci = (obj.ipa.indexOf("U+") != -1 ? String.fromCodePoint(parseInt(obj.ipa.slice(2), 16)) : (obj.ipa.indexOf("CJKF") != -1 ? "f" : "x"));
        let cj = !obj.jmj ? "x" : String.fromCodePoint(parseInt(obj.jmj, 16));

        if (ci == "f") ci = cj;
        else
        if ((ci == cj) && !jivs) return;

        var tret = {dkw:dkw, c:[ci,cj]};
        tret.type = tret.c.map(
            (cs,i) => cs=="x"?"x":
                Array.from(cs).map(c => {
                    if (c == ci) return "A";
                    if (is_cjkcompat(c) == ci) return "a";
                    //if (i==1 && cj == ck) return "B";
                    return "B";
                }).join("")
        );

        if (jivs) tret.type[1] += "*";

        tret.type = tret.type.join(":");
        return tret;

    }).filter(v => v)
      .sort((a,b)=>(a.type == b.type ? (a.dkw < b.dkw ? -1 : 1) : (a.type < b.type ? -1 : 1)))
      .forEach(d => {
          var obj = ret[d.dkw];
          var c = d.c;
          if (!obj.jmj) obj.jmj = "-----";

          console.log([d.dkw, d.type,
                       obj.jmj + "(" + c[1]+")",
                       obj.ipa + "(" + c[0] + ")",
                      ].join("\t"));
    });
};

const dump_diff = () => {
    const ret = loadfiles();

    var diff = Object.keys(ret).map(dkw => {
        var obj = ret[dkw];

        var jivs = obj.jmj && (obj.jmj.indexOf("_") != -1);
        var kdup = obj.kdb.length && (obj.kdb[0].slice(0,1) == "=");

        let ci = (obj.ipa.indexOf("U+") != -1 ? String.fromCodePoint(parseInt(obj.ipa.slice(2), 16)) : (obj.ipa.indexOf("CJKF") != -1 ? "f" : "x"));
        let cj = !obj.jmj ? "x" : String.fromCodePoint(parseInt(obj.jmj, 16));
        let ck = obj.kdb.map(v => String.fromCodePoint(parseInt((kdup ? ret[v.slice(1)].kdb[0] : v).slice(2), 16) || 0x52)).join("");

        if (ci == "f") ci = cj;
        if (ck == "") ck = "x";
        
        if ((ci == cj) && !jivs && (ci == ck) && !kdup) return {dkw:dkw, c:[ci,cj,ck], type:""};

        var tret = {dkw:dkw, c:[ci,cj,ck]};
        tret.type = tret.c.map(
            (cs,i) => cs=="x"?"x":
                Array.from(cs).map(c => {
                    if (c == ci) return "A";
                    if (is_cjkcompat(c) == ci) return "a";
                    //if (i==1 && cj == ck) return "B";
                    return "B";
                }).join("")
        );

        if (jivs) tret.type[1] += "*";
        if (kdup) tret.type[2] += "=";

        tret.type = tret.type.join(":");
        return tret;
    }).filter(v => v);

    const dry = false;

    diff.sort((a,b)=>((a.type == b.type) ? (a.dkw < b.dkw ? -1:1): (a.type < b.type ? -1:1))).map(d => {
        var obj = ret[d.dkw];
        var c = d.c;
        if (!obj.jmj) obj.jmj = "-";
        if (!obj.ipa) obj.ipa = "-";
        if (!obj.kdb.length) obj.kdb = ["-"];

        //if (is_cjkcompat(c0) == c2)
		//	console.log(dkw,  utf+"("+c1+")", "=", ret[dkw]+"(" + c0+")");
		//else
        var prv = (Object.keys(prv_list).indexOf(d.dkw) != -1) ? prv_list[d.dkw] : "";
        if (dry) {
		    console.log(d.dkw,  c.join("\t"), [obj.ipa, obj.jmj, obj.kdb.join(";")].join("\t"), d.type, prv);
            return;
        }

        var X = {d:d.dkw, j:"", p:"", k:"", i:""}
        X.j = c[1];

        if (c[0] != c[1]) X.i = c[0];
        if (omitlist.ipa.indexOf(d.dkw) != -1) X.i = "#" + X.i;

        if (c[2] != ((c[1] == "x") ? c[0] : c[1])) X.k = c[2];
        if (prv) {
            prv = prv.shift();
            prv = prv.split("_xx").shift();
            if (c.indexOf(prv) == -1) X.p = prv;
        }
        if (d.type) X.type = ((t) => { var t = t.split(":"); return [t[1],t[0],t[2]].join("-"); })(d.type);
        if (obj.jmj.indexOf("_E01")!=-1) X.j += "_" + obj.jmj.split("_E01").pop();
        var kdup = obj.kdb.length && (obj.kdb[0].slice(0,1) == "=");
        if (kdup) X.k = obj.kdb.join("") + ":" + X.k;
        if (omitlist.kdb.indexOf(d.dkw) != -1) X.k = "#" + X.k;
        //console.log(JSON.stringify(X));
        console.log([X.d,X.j, X.i, X.k, X.p].join("\t"));
	});


};
dump_diff();


const test = () => {
    var ret = [];
    getfile("dkwdiff-kdb.txt", (err, txt) => {
        ret = txt.split("\n").map((line, i) => {
            if (!line) return;
            var row = line.trim().split("\t");
            if (row[0].slice(0,2)=="# ") return;
            if (row[1] == "x:A") return;
            if (row[0].slice(0,1)=="#") return row.shift().slice(1);
            return row.shift();
        }).filter(v=>v).sort();
    });
    getfile("kdbdiff.txt", (err, txt) => {
        var ret2 = txt.split("\n").map((line, i) => {
            if (!line) return;
            var dkw =  line.trim().split("\t").shift();
            if (dkw.slice(0,2)=="# ") return;
            if (dkw.slice(0,1)=="#") return [dkw.slice(1), line];
            return [dkw, line];
        }).filter(v=>v).map(v => {
            v[0] = format_dkw(v[0].match(/^(h?)([0-9]+)('*)$/));
            return v;
        });
        
        console.log(ret2.length, ret.length);
        var j = -1;
        ret2.sort((a,b)=>a<b?-1:1).forEach((v,i) => {
            j++;
            console.log(ret[j], v);
            if (ret[j] == v[0]) return;
            console.log("#");
            j--;
        });
    });
};

